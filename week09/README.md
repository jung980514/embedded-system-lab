# 임베디드 시스템 설계 및 실험 9주차 결과 보고서
7조 이석우, 손수민, 김춘수, 정지용
 
## 1. 실험 목표
1. 블루투스 모듈의 각 핀 별 담당하는 기능을 학습하고, 통신에 이용한다.
2. 블루투스 모듈의 레퍼런스를 참고하여 프로그램 코드를 작성한다. 
3. 블루투스 통신에 필요한 장치들을 납땜을 통해 연결한다.


## 2.배경 지식
### Bluetooth 모듈
&nbsp;&nbsp; Bluetooth(블루투스)란 1994년 스웨덴 에릭슨 기업에서 개발한 디지털 통신 기기를 위한 개인 근거리 무선 통신 기술의 표준으로, 데이터 전송 거리는 10m~100m정도이다. 좁은 대역대에 많은 기기가 물려서 통신에 방해가 될 수 있어 frequency hopping기법을 이용하여 간섭 및 fading을 방지한다. Master/slave 모드로 동작하며, master는 검색 및 연결요청 등을 담당하며, slave는 검색 대기 및 연결 대기를 담당한다.   
&nbsp;&nbsp; Master가 주변 slave를 탐색하여 발견하면, slave는 자신의 정보를 master에게 발신한다. Bluetooth 장치 하나당 7개의 장치가 동시에 접속이 가능하다. 그리고 블루투스 연결을 위해서 master가 생성하는 주파수 hopping에 slave가 동기화 되어 있어야 한다. 블루투스는 단거리 통신, 저전력, 높은 신뢰성, 저가의 무선 통신을 구현한다는 장점이 있다. 

### Bluetooth Profile(spp)
&nbsp;&nbsp; 블루투스 프로파일이란 보내는 데이터의 종류를 명확하게 정의하기 위한 블루투스 기본 구조 위에 추가로 정의된 프로토콜이다. 블루투스 무선 기술은 다양한 장비에 장착되어 이용되고 있고, 따라서 더 많은 기기와의 호환성문제를 해결하기 위해 기기 종류 간에 프로토콜을 정의한다. 즉, 기기마다 연결 프로파일이 다르기 때문에 이 기기와 연결이 되려면 블루투스 모듈이 이 프로파일 모두를 지원해야 한다. 이번 실험에서 사용할 프로파일은 SPP(serial port profile)이고, 이는 RS232시리얼 케이블 에뮬레이션을 위한 블루투스 기기에 사용되는 프로파일이고, 시리얼 통신을 이용하여 데이터를 송수신하는 프로파일로 SPP사용 시에 두 장치는 RX,TX가 유선으로 연결된 것처럼 동작하게 된다. 

### Bluetooth SSID/UUID
&nbsp;&nbsp; 32바이트 길이의 고유한 identifier이다. 무선 장치들이 bss에 접속할 때, 암호처럼 사용된다. Ssid는 무선랜을 통해 클라이언트가 접속할 때, 각 무선랜을 구별하기 위한 고유 식별자이고, 와이파이의 경우에는 각 와이파이 네트워크를 구별하기 위해 사용된다.    
&nbsp;&nbsp; UUID는 네트워크 상에서 서로 다른 개체들을 구별하기 위한 128비트 고유 식별자로 블루투스에서는 서비스의 종류를 구분하기 위해 사용된다. 

### Bluetooth module(FB755AC)
&nbsp;&nbsp; Firmtech사에서 개발한 모듈로, master와 slave형태의 주종관계로 구성되어 있다. 하나의 모듈에 최대 7개의 slave(장치)가 동시에 접속이 가능하다. 블루  투스 버전은 2.0이며, 통신 거리는 100m이고, 인터페이스는 uart이다. 12개의   핀 헤더로 구성되어 있고, AT명령어를 지원하여 AT명령어를 이용하여 FB755AC의 제어가 가능하다.    
&nbsp;&nbsp; STATUS PIN은 블루투스 모듈의 상태를 모니터링 하기 위해 사용한다. 블루투스 연결 대기중이거나 연결 시도, 주변 블루투스 장치 검색에는 LOW, HIGH를 반복한다.    
&nbsp;&nbsp; STREAM CONTROL, STREAM_STATUS, MESSAGE_CONTROL, MESSAGE_STATUS은 1:N통신을 할 때 연결하며, 1:1통신 시에는 필요없다.    
&nbsp;&nbsp; CONFIG SELECT는 블루투스 모듈 설정시에 전원을 인가하여 사용한다. HIGH(전원)을 입력한 채로 전원을 켜면 설정 모드로 진입한다.    
&nbsp;&nbsp; CONNECT CHECK/DCD는 설정된 연결 수 만큼 MASTER 연결 시 LOW, 하나라도 해지되면 HIGH로 바뀐다. 

### AT 명령어
&nbsp;&nbsp; AT명령어의 AT는 attention의 앞 두글자를 따서 만든 것이고, AT_COMMAND와 같이 적어 이용한다. COMMAND부분에 원하는 명령어를 적으면 된다. 이번 실험에서는 블루투스 모듈이 모바일 디바이스(스마트폰)과 연결 및 검색할 수 있도록 하기 위해 AT+BTSCAN을 이용한다. 

## 3. 실험 내용
&nbsp;&nbsp; 이번 주 실험에서는 블루투스 모듈을 사용하여 폰과 보드 그리고, 컴퓨터의 통신을
진행하는 것이다. 미션 내용은 다음과 같다.
- 블루투스 통신을 위한 적절한 납땜,
- 앱 설치 및 블루투스 사용을 위한 설정
- Serial Bluetooth Terminal 어플리케이션을 이용하여 putty와 통신
- Pc의 putty에 입력 시 블루투스 모듈을 통해 스마트폰 화면에 출력
- 스마트폰 터미널에 입력 시 putty 터미널에 출력
- 블루투스 모듈 configuration

블루투스 모듈의 CONFIG SELECT에 3.3v를 인가하여 putty에서 블루투스 모듈 설정창에 접속한다.
여기서 device name, Pincode (블루투스 연결 비밀번호), Connection mode 4 salve, Uart Config (9600, 8, n, 1) 을 설정한다.
 CONFIG SELECT에 3.3v 입력을 해제하고 보드 전원을 껐다 키면 AT명령어 대기 모드로 돌입한다. 이 상태에서 "AT+BTSCAN" 명령어를 입력하여 연결 대기에 들어가면 스마트폰으로 블루투스 연결을 한다. 그러면 Serial Bluetooth Terminal 앱을 이용하여 putty로 통신이 가능해진다. 
 
## 4. 코드 설명
&nbsp;&nbsp; 이번 실험에서는 블루투스 통신을 위하여, 지난 주 코드에서 Usart2 부분을
추가적으로 작성해 주었다. Usart1_irqhandler함수에서는 usart1 인터럽트를
통한 동작에 관하여 작성하였고, 데이터 입력 시 usart1을 통하여 보드로 전
송하고, 보드에서 다시 usart2를 통해 휴대용 단말기로 전송하기 때문에 전
주에 비해 추가적인 작성이 필요하였다. Usart2_irqhandler함수에서는 usart2
인터럽트 발생시 작동하는 내용을 작성하였고, 데이터가 입력시 보드를 통해
usart1으로 전송하도록 하였다.

## 5. 실험 결론
&nbsp;&nbsp; 금주 실험에서는 전주 실험에서 사용된 코드에서 블루투스 통신을 위한 usart2 부분을 추가로 작성하였고, 납땜을 통한 보드 모듈 사용이 주를 이루었다. 대부분 조원들이 납땜경험이 적거나, 없었기 때문에 간단한 작업임에도 생각보다 시간이 소비되었다. 실험내용 대로 납땜을 완료한 후 블루투스 모듈을 이용한 보드와 스마트 폰간의 통신을 이루어냈다.   
&nbsp;&nbsp; 향후, 프로젝트에서 블루투스 통신이 필수적인 만큼 금주 실험 내용을 잘 기억해놓을 필요성이 있을 것 같다.

